services:
  db:
    networks:
      default:
        aliases:
          - mysql
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-shopware}
      DB_AUTO_CREATE_DB: ${DB_AUTO_CREATE_DB:-shopware shopware_e2e shopware_test}
      DB_AUTO_CREATE_SH: |-
        if [ -n "$$DB_USER" ] && [ -n "$$DB_AUTO_CREATE_DB" ]; then
          for DB_DATABASE in $$DB_AUTO_CREATE_DB; do
            mysql_note "Creating database $${DB_DATABASE}"
            docker_process_sql --database=$${DB_DATABASE} <<<"CREATE DATABASE IF NOT EXISTS \`$$DB_DATABASE\`;"

            mysql_note "Giving user $${DB_USER} access to schema $${DB_DATABASE}"
            docker_process_sql --database=$${DB_DATABASE} <<<"GRANT ALL ON \`$${DB_DATABASE//_/\\_}\`.* TO '$$DB_USER'@'%';"
          done
          docker_process_sql --database=$${DB_DATABASE} <<<"FLUSH PRIVILEGES;"
        fi
    entrypoint: |
      /bin/bash -c '
        echo "$$DB_AUTO_CREATE_SH" > /docker-entrypoint-initdb.d/db-auto-create.sh
        exec /usr/local/bin/docker-entrypoint.sh mysqld
      '
